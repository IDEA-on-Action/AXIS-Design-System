# Evals Regression Suite CI ì›Œí¬í”Œë¡œ
#
# ëª©ì : PR/ì»¤ë°‹ ì‹œ ì—ì´ì „íŠ¸ ë™ìž‘ íšŒê·€ í…ŒìŠ¤íŠ¸ ìžë™ ì‹¤í–‰
# íŠ¸ë¦¬ê±°:
#   - PR ìƒì„±/ì—…ë°ì´íŠ¸ (main, develop ë¸Œëžœì¹˜)
#   - main ë¸Œëžœì¹˜ push
#   - ìˆ˜ë™ ì‹¤í–‰ (workflow_dispatch)
#   - ìŠ¤ì¼€ì¤„ (í‰ì¼ ì˜¤ì „ 9ì‹œ KST)
#
# í•„ìš”í•œ Secrets:
#   ANTHROPIC_API_KEY: Anthropic API í‚¤ (í•„ìˆ˜)
#   CONFLUENCE_URL: Confluence URL (ì„ íƒ)
#   CONFLUENCE_USERNAME: Confluence ì‚¬ìš©ìžëª… (ì„ íƒ)
#   CONFLUENCE_API_TOKEN: Confluence API í† í° (ì„ íƒ)
#
# ì„¤ì • ë°©ë²•:
#   1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions
#   2. 'New repository secret' í´ë¦­
#   3. Name: ANTHROPIC_API_KEY, Value: sk-ant-... (Anthropic API í‚¤)
#   4. https://console.anthropic.com/settings/keys ì—ì„œ API í‚¤ ë°œê¸‰

name: Evals Regression Suite

on:
  # PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ì‹¤í–‰
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - 'evals/**'
      - '.claude/**'
      - 'pyproject.toml'

  # main ë¸Œëžœì¹˜ push ì‹œ ì „ì²´ suite ì‹¤í–‰
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'evals/**'
      - '.claude/**'

  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      suite:
        description: 'ì‹¤í–‰í•  Suite (regression, capability, ë˜ëŠ” ê²½ë¡œ)'
        required: false
        default: 'regression'
        type: string
      k:
        description: 'Trial íšŸìˆ˜ (1-10)'
        required: false
        default: '3'
        type: string
      task:
        description: 'íŠ¹ì • Task ID (ì„ íƒì‚¬í•­, ì‰¼í‘œ êµ¬ë¶„)'
        required: false
        type: string
      dry_run:
        description: 'Dry run ëª¨ë“œ (ì‹¤ì œ ì‹¤í–‰ ì—†ì´ ê²€ì¦ë§Œ)'
        required: false
        default: false
        type: boolean

  # ìŠ¤ì¼€ì¤„: í‰ì¼ ì˜¤ì „ 9ì‹œ (KST) = ì˜¤ì „ 0ì‹œ (UTC)
  schedule:
    - cron: '0 0 * * 1-5'

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ê°™ì€ PRì—ì„œ ì—¬ëŸ¬ ì»¤ë°‹ ì‹œ ì´ì „ ì‹¤í–‰ ì·¨ì†Œ)
concurrency:
  group: evals-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Python ë²„ì „
  PYTHON_VERSION: '3.11'
  # ê¸°ë³¸ Suite
  DEFAULT_SUITE: 'regression'
  # ê¸°ë³¸ Trial íšŸìˆ˜
  DEFAULT_K: '3'
  # íƒ€ìž„ì•„ì›ƒ (ë¶„)
  TIMEOUT_MINUTES: 30

jobs:
  # ============================================================================
  # ì‚¬ì „ ê²€ì¦ (ìœ íš¨ì„± ê²€ì‚¬)
  # ============================================================================
  validate:
    name: YAML ìœ íš¨ì„± ê²€ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: pip ìºì‹±
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Suite/Task YAML ìœ íš¨ì„± ê²€ì‚¬
        run: |
          # globstar í™œì„±í™” (bashì—ì„œ ** íŒ¨í„´ ì§€ì›)
          shopt -s globstar nullglob

          echo "ðŸ“‹ Suite YAML ê²€ì‚¬..."
          suite_count=0
          for suite_file in evals/suites/**/*.yaml; do
            if [ -f "$suite_file" ]; then
              echo "  ê²€ì‚¬ ì¤‘: $suite_file"
              python -m backend.evals validate "$suite_file" --type suite || exit 1
              suite_count=$((suite_count + 1))
            fi
          done
          echo "  Suite íŒŒì¼ ${suite_count}ê°œ ê²€ì‚¬ ì™„ë£Œ"

          echo "ðŸ“‹ Task YAML ê²€ì‚¬..."
          task_count=0
          for task_file in evals/tasks/**/*.yaml; do
            if [ -f "$task_file" ]; then
              echo "  ê²€ì‚¬ ì¤‘: $task_file"
              python -m backend.evals validate "$task_file" --type task || exit 1
              task_count=$((task_count + 1))
            fi
          done
          echo "  Task íŒŒì¼ ${task_count}ê°œ ê²€ì‚¬ ì™„ë£Œ"

          echo "âœ… ëª¨ë“  YAML ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ (Suite: ${suite_count}, Task: ${task_count})"

  # ============================================================================
  # Regression Suite ì‹¤í–‰
  # ============================================================================
  regression:
    name: Regression Suite ì‹¤í–‰
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # ì¡°ê±´: dry_runì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    if: ${{ github.event.inputs.dry_run != 'true' }}

    # í™˜ê²½ ë³€ìˆ˜ (ë¯¼ê° ì •ë³´ëŠ” secrets ì‚¬ìš©)
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
      CONFLUENCE_USERNAME: ${{ secrets.CONFLUENCE_USERNAME }}
      CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}

    steps:
      - name: API í‚¤ í™•ì¸
        id: check
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "â­ï¸ ANTHROPIC_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ Regression Suiteë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo ""
            echo "ðŸ”§ ì„¤ì • ë°©ë²•:"
            echo "  1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "  2. 'New repository secret' í´ë¦­"
            echo "  3. Name: ANTHROPIC_API_KEY"
            echo "  4. Value: sk-ant-... (Anthropic API í‚¤)"
            echo ""
            echo "ðŸ“š ì°¸ê³ : https://console.anthropic.com/settings/keys"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout ì½”ë“œ
        if: steps.check.outputs.skip != 'true'
        uses: actions/checkout@v4

      - name: Python ì„¤ì •
        if: steps.check.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: pip ìºì‹±
        if: steps.check.outputs.skip != 'true'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        if: steps.check.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ì‹¤í–‰ íŒŒë¼ë¯¸í„° ì„¤ì •
        if: steps.check.outputs.skip != 'true'
        id: params
        run: |
          # Suite ê²°ì •
          SUITE="${{ github.event.inputs.suite || env.DEFAULT_SUITE }}"
          echo "suite=$SUITE" >> $GITHUB_OUTPUT

          # Trial íšŸìˆ˜ ê²°ì •
          K="${{ github.event.inputs.k || env.DEFAULT_K }}"
          echo "k=$K" >> $GITHUB_OUTPUT

          # Task í•„í„° (ìžˆëŠ” ê²½ìš°)
          TASK="${{ github.event.inputs.task || '' }}"
          if [ -n "$TASK" ]; then
            echo "task_filter=--task $TASK" >> $GITHUB_OUTPUT
          else
            echo "task_filter=" >> $GITHUB_OUTPUT
          fi

          echo "ðŸ“Š ì‹¤í–‰ íŒŒë¼ë¯¸í„°:"
          echo "  Suite: $SUITE"
          echo "  K: $K"
          echo "  Task: ${TASK:-ì „ì²´}"

      - name: Evals Regression Suite ì‹¤í–‰
        if: steps.check.outputs.skip != 'true'
        id: evals
        run: |
          echo "ðŸš€ Evals ì‹¤í–‰ ì‹œìž‘..."
          echo "  Suite: ${{ steps.params.outputs.suite }}"
          echo "  K: ${{ steps.params.outputs.k }}"

          # ê²°ê³¼ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p results

          # Evals ì‹¤í–‰
          python -m backend.evals run \
            --suite "${{ steps.params.outputs.suite }}" \
            --k "${{ steps.params.outputs.k }}" \
            --parallel \
            --parallel-workers 4 \
            --output json \
            ${{ steps.params.outputs.task_filter }} \
            > results/eval-result.json 2>&1 || EVAL_EXIT_CODE=$?

          # ê²°ê³¼ ì €ìž¥
          echo "exit_code=${EVAL_EXIT_CODE:-0}" >> $GITHUB_OUTPUT

          # ìš”ì•½ ì¶œë ¥
          echo ""
          echo "ðŸ“‹ ê²°ê³¼ ìš”ì•½:"
          python -m backend.evals run \
            --suite "${{ steps.params.outputs.suite }}" \
            --k "${{ steps.params.outputs.k }}" \
            --parallel \
            --output summary \
            ${{ steps.params.outputs.task_filter }} || true

      - name: ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always() && steps.check.outputs.skip != 'true'
        with:
          name: eval-results-${{ github.run_id }}
          path: results/
          retention-days: 30

      - name: PR ì½”ë©˜íŠ¸ ìž‘ì„±
        if: github.event_name == 'pull_request' && steps.check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // ê²°ê³¼ íŒŒì¼ ì½ê¸°
            let resultData = {};
            try {
              const content = fs.readFileSync('results/eval-result.json', 'utf8');
              resultData = JSON.parse(content);
            } catch (e) {
              console.log('ê²°ê³¼ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', e.message);
            }

            // ìš”ì•½ ìƒì„±
            const passed = resultData.gate_passed ?? false;
            const decision = resultData.decision ?? 'UNKNOWN';
            const passRate = resultData.overall_pass_rate ?? 0;
            const avgScore = resultData.overall_avg_score ?? 0;
            const taskResults = resultData.task_results ?? [];

            // ì´ëª¨ì§€ ê²°ì •
            const statusEmoji = passed ? 'âœ…' : 'âŒ';
            const statusText = passed ? 'í†µê³¼' : 'ì‹¤íŒ¨';

            // Task ê²°ê³¼ í…Œì´ë¸” ìƒì„±
            let taskTable = '';
            if (taskResults.length > 0) {
              taskTable = '\n| Task | ìƒíƒœ | Pass@K | í‰ê·  ì ìˆ˜ |\n|------|------|--------|----------|\n';
              for (const task of taskResults) {
                const taskStatus = task.passed ? 'âœ…' : 'âŒ';
                taskTable += `| ${task.task_id} | ${taskStatus} | ${(task.pass_at_k * 100).toFixed(0)}% | ${task.avg_score.toFixed(2)} |\n`;
              }
            }

            // ì½”ë©˜íŠ¸ ë³¸ë¬¸
            const body = `## ${statusEmoji} Evals Regression Suite ${statusText}

            **íŒì •**: ${decision}
            **í†µê³¼ìœ¨**: ${(passRate * 100).toFixed(1)}%
            **í‰ê·  ì ìˆ˜**: ${avgScore.toFixed(2)}

            ### Task ê²°ê³¼
            ${taskTable}

            > ìƒì„¸ ê²°ê³¼ëŠ” [Actions ì•„í‹°íŒ©íŠ¸](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ì—ì„œ í™•ì¸í•˜ì„¸ìš”.
            `;

            // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(
              c => c.user.login === 'github-actions[bot]' &&
                   c.body.includes('Evals Regression Suite')
            );

            // ì½”ë©˜íŠ¸ ìž‘ì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body.trim(),
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body.trim(),
              });
            }

      - name: ê²Œì´íŠ¸ ê²°ê³¼ í™•ì¸
        if: steps.check.outputs.skip != 'true'
        run: |
          EXIT_CODE="${{ steps.evals.outputs.exit_code }}"

          if [ "$EXIT_CODE" = "0" ]; then
            echo "âœ… ê²Œì´íŠ¸ í†µê³¼: ëª¨ë“  ì¡°ê±´ ì¶©ì¡±"
            exit 0
          elif [ "$EXIT_CODE" = "2" ]; then
            echo "âš ï¸ MARGINAL: ì¼ë¶€ ì¡°ê±´ ë¯¸ë‹¬ (ê²€í†  í•„ìš”)"
            # MARGINALì€ ê²½ê³ ë§Œ í•˜ê³  í†µê³¼ ì²˜ë¦¬
            exit 0
          else
            echo "âŒ ê²Œì´íŠ¸ ì‹¤íŒ¨: ì¡°ê±´ ë¯¸ì¶©ì¡±"
            exit 1
          fi

  # ============================================================================
  # Dry Run (ìœ íš¨ì„± ê²€ì‚¬ë§Œ)
  # ============================================================================
  dry-run:
    name: Dry Run ê²€ì¦
    needs: validate
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.dry_run == 'true' }}

    steps:
      - name: Dry Run ì™„ë£Œ
        run: |
          echo "âœ… Dry run ëª¨ë“œ: YAML ìœ íš¨ì„± ê²€ì‚¬ ì™„ë£Œ"
          echo "   ì‹¤ì œ Evals ì‹¤í–‰ì€ ê±´ë„ˆëœë‹ˆë‹¤."

  # ============================================================================
  # ê²°ê³¼ ìš”ì•½ (ì„ íƒì )
  # ============================================================================
  summary:
    name: ê²°ê³¼ ìš”ì•½
    needs: [validate, regression]
    runs-on: ubuntu-latest
    if: ${{ always() && github.event.inputs.dry_run != 'true' }}

    steps:
      - name: ì›Œí¬í”Œë¡œ ìš”ì•½
        run: |
          echo "## ðŸ“Š Evals Regression Suite ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ê²€ì¦ ë‹¨ê³„ ê²°ê³¼
          VALIDATE_RESULT="${{ needs.validate.result }}"
          if [ "$VALIDATE_RESULT" = "success" ]; then
            echo "- âœ… YAML ìœ íš¨ì„± ê²€ì‚¬: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ YAML ìœ íš¨ì„± ê²€ì‚¬: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          # íšŒê·€ í…ŒìŠ¤íŠ¸ ê²°ê³¼
          REGRESSION_RESULT="${{ needs.regression.result }}"
          if [ "$REGRESSION_RESULT" = "success" ]; then
            echo "- âœ… Regression Suite: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          elif [ "$REGRESSION_RESULT" = "skipped" ]; then
            echo "- â­ï¸ Regression Suite: ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Regression Suite: ì‹¤íŒ¨ ë˜ëŠ” ê±´ë„ˆëœ€ (ANTHROPIC_API_KEY ë¯¸ì„¤ì • ê°€ëŠ¥)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ìƒì„¸ ë¡œê·¸ëŠ” ê° Jobì„ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
