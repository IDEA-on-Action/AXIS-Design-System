name: CD Backend (Render)

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'pyproject.toml'
      - 'render.yaml'

# í•„ìš”í•œ Secrets:
#   RENDER_PRODUCTION_DEPLOY_HOOK: Render í”„ë¡œë•ì…˜ ë°°í¬ Webhook URL
#
# í•„ìš”í•œ Variables:
#   PRODUCTION_API_URL: í”„ë¡œë•ì…˜ API URL (ì˜ˆ: https://ax-discovery-api.onrender.com)

jobs:
  # ===========================================
  # Production ë°°í¬
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Check deploy hook
        id: check
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "â­ï¸ RENDER_PRODUCTION_DEPLOY_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Render Production
        if: steps.check.outputs.skip != 'true'
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}
        run: |
          echo "ğŸš€ Production ë°°í¬ ì‹œì‘..."
          response=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_HOOK")
          http_code=$(echo "$response" | tail -n1)
          # Render Deploy Hookì€ 202 (Accepted) ë°˜í™˜
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ] && [ "$http_code" != "202" ]; then
            echo "âŒ Deploy hook í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
            exit 1
          fi
          echo "âœ… Deploy hook í˜¸ì¶œ ì„±ê³µ (HTTP $http_code)"

      - name: Wait for deployment
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "â³ Render ë°°í¬ ëŒ€ê¸° ì¤‘ (90ì´ˆ)..."
          sleep 90

      - name: Health check (with retry)
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "ğŸ¥ Production í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          API_URL="${{ vars.PRODUCTION_API_URL }}"
          if [ -z "$API_URL" ]; then
            API_URL="https://ax-discovery-api.onrender.com"
          fi
          max_attempts=10
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            response=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed on attempt $i"
              exit 0
            fi
            echo "âš ï¸ Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1
