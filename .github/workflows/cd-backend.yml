name: CD Backend (Render)

on:
  push:
    branches: [main, staging]
    paths:
      - 'backend/**'
      - 'pyproject.toml'
      - 'render.yaml'
      - 'Dockerfile'

# í•„ìš”í•œ Secrets:
#   RENDER_STAGING_DEPLOY_HOOK: Render ìŠ¤í…Œì´ì§• ë°°í¬ Webhook URL
#   RENDER_PRODUCTION_DEPLOY_HOOK: Render í”„ë¡œë•ì…˜ ë°°í¬ Webhook URL
#
# í•„ìš”í•œ Variables:
#   STAGING_API_URL: ìŠ¤í…Œì´ì§• API URL (ì˜ˆ: https://api-staging.axdiscovery.com)
#   PRODUCTION_API_URL: í”„ë¡œë•ì…˜ API URL (ì˜ˆ: https://api.axdiscovery.com)
#
# ì„¤ì • ë°©ë²•:
#   1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions
#   2. Secrets íƒ­ì—ì„œ 'New repository secret' í´ë¦­
#   3. Render Dashboard â†’ Web Service â†’ Settings â†’ Deploy Hookì—ì„œ URL ë³µì‚¬

jobs:
  # ===========================================
  # Staging ë°°í¬
  # ===========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'

    steps:
      - name: Check deploy hook
        id: check
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "â­ï¸ RENDER_STAGING_DEPLOY_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo ""
            echo "ğŸ”§ ì„¤ì • ë°©ë²•:"
            echo "  1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "  2. Secrets íƒ­ì—ì„œ 'New repository secret' í´ë¦­"
            echo "  3. Name: RENDER_STAGING_DEPLOY_HOOK"
            echo "  4. Value: Render Dashboard â†’ Web Service â†’ Settings â†’ Deploy Hook URL"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Render Staging
        if: steps.check.outputs.skip != 'true'
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}
        run: |
          echo "ğŸš€ Staging ë°°í¬ ì‹œì‘..."
          response=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_HOOK")
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
            echo "âŒ Deploy hook í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
            exit 1
          fi
          echo "âœ… Deploy hook í˜¸ì¶œ ì„±ê³µ"

      - name: Wait for deployment
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "â³ Render ë°°í¬ ëŒ€ê¸° ì¤‘ (90ì´ˆ)..."
          sleep 90

      - name: Health check (with retry)
        if: steps.check.outputs.skip != 'true' && vars.STAGING_API_URL != ''
        run: |
          echo "ğŸ¥ Staging í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          max_attempts=10
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.STAGING_API_URL }}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed on attempt $i"
              exit 0
            fi
            echo "âš ï¸ Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1

  # ===========================================
  # E2E í…ŒìŠ¤íŠ¸ (Staging)
  # ===========================================
  e2e-test-staging:
    name: E2E Test (Staging)
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: vars.STAGING_API_URL != ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run E2E health checks
        run: |
          echo "ğŸ§ª E2E í…ŒìŠ¤íŠ¸ ì‹œì‘..."

          # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
          echo "Testing /health..."
          curl -f "${{ vars.STAGING_API_URL }}/health" || exit 1

          # Liveness probe
          echo "Testing /health/live..."
          curl -f "${{ vars.STAGING_API_URL }}/health/live" || exit 1

          # Readiness probe
          echo "Testing /health/ready..."
          curl -f "${{ vars.STAGING_API_URL }}/health/ready" || exit 1

          # API ì‘ë‹µ ì²´í¬
          echo "Testing /..."
          curl -f "${{ vars.STAGING_API_URL }}/" || exit 1

          echo "âœ… E2E í…ŒìŠ¤íŠ¸ í†µê³¼"

  # ===========================================
  # Production ë°°í¬
  # ===========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: e2e-test-staging
    environment: production
    # main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ í”„ë¡œë•ì…˜ ë°°í¬
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Check deploy hook
        id: check
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "â­ï¸ RENDER_PRODUCTION_DEPLOY_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo ""
            echo "ğŸ”§ ì„¤ì • ë°©ë²•:"
            echo "  1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "  2. Secrets íƒ­ì—ì„œ 'New repository secret' í´ë¦­"
            echo "  3. Name: RENDER_PRODUCTION_DEPLOY_HOOK"
            echo "  4. Value: Render Dashboard â†’ Web Service â†’ Settings â†’ Deploy Hook URL"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Render Production
        if: steps.check.outputs.skip != 'true'
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}
        run: |
          echo "ğŸš€ Production ë°°í¬ ì‹œì‘..."
          response=$(curl -s -w "\n%{http_code}" -X POST "$DEPLOY_HOOK")
          http_code=$(echo "$response" | tail -n1)
          if [ "$http_code" != "200" ] && [ "$http_code" != "201" ]; then
            echo "âŒ Deploy hook í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
            exit 1
          fi
          echo "âœ… Deploy hook í˜¸ì¶œ ì„±ê³µ"

      - name: Wait for deployment
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "â³ Render ë°°í¬ ëŒ€ê¸° ì¤‘ (90ì´ˆ)..."
          sleep 90

      - name: Health check (with retry)
        if: steps.check.outputs.skip != 'true' && vars.PRODUCTION_API_URL != ''
        run: |
          echo "ğŸ¥ Production í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          max_attempts=10
          for i in $(seq 1 $max_attempts); do
            echo "Attempt $i/$max_attempts..."
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.PRODUCTION_API_URL }}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed on attempt $i"
              exit 0
            fi
            echo "âš ï¸ Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1
