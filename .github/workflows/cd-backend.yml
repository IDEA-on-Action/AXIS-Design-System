name: CD Backend (Render)

on:
  push:
    branches: [main, staging]
    paths:
      - 'backend/**'
      - 'pyproject.toml'
      - 'render.yaml'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    # main 또는 staging 브랜치 푸시 시 스테이징 배포
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'

    steps:
      - name: Deploy to Render Staging
        run: |
          curl -X POST "${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}"

      - name: Wait for deployment
        run: sleep 60

      - name: Health check (with retry)
        run: |
          for i in 1 2 3 4 5; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.STAGING_API_URL }}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i: Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "Health check failed after 5 attempts"
          exit 1
        continue-on-error: true

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    # main 브랜치 푸시 시에만 프로덕션 배포
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to Render Production
        run: |
          curl -X POST "${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}"

      - name: Wait for deployment
        run: sleep 60

      - name: Health check (with retry)
        run: |
          for i in 1 2 3 4 5; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.PRODUCTION_API_URL }}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i: Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "Health check failed after 5 attempts"
          exit 1
        continue-on-error: true
