name: CD Backend (Render)

on:
  push:
    branches: [main, staging]
    paths:
      - 'backend/**'
      - 'pyproject.toml'
      - 'render.yaml'

# í•„ìš”í•œ Secrets:
#   RENDER_STAGING_DEPLOY_HOOK: Render ìŠ¤í…Œì´ì§• ë°°í¬ Webhook URL
#   RENDER_PRODUCTION_DEPLOY_HOOK: Render í”„ë¡œë•ì…˜ ë°°í¬ Webhook URL
#
# í•„ìš”í•œ Variables:
#   STAGING_API_URL: ìŠ¤í…Œì´ì§• API URL (health checkìš©)
#   PRODUCTION_API_URL: í”„ë¡œë•ì…˜ API URL (health checkìš©)
#
# ì„¤ì • ë°©ë²•:
#   1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions
#   2. Secrets íƒ­ì—ì„œ 'New repository secret' í´ë¦­
#   3. Render Dashboard â†’ Web Service â†’ Settings â†’ Deploy Hookì—ì„œ URL ë³µì‚¬

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    # main ë˜ëŠ” staging ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ë°°í¬
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'

    steps:
      - name: Check deploy hook
        id: check
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "â­ï¸ RENDER_STAGING_DEPLOY_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo ""
            echo "ðŸ”§ ì„¤ì • ë°©ë²•:"
            echo "  1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "  2. Secrets íƒ­ì—ì„œ 'New repository secret' í´ë¦­"
            echo "  3. Name: RENDER_STAGING_DEPLOY_HOOK"
            echo "  4. Value: Render Dashboard â†’ Web Service â†’ Settings â†’ Deploy Hook URL"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Render Staging
        if: steps.check.outputs.skip != 'true'
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_STAGING_DEPLOY_HOOK }}
        run: |
          curl -X POST "$DEPLOY_HOOK"

      - name: Wait for deployment
        if: steps.check.outputs.skip != 'true'
        run: sleep 60

      - name: Health check (with retry)
        if: steps.check.outputs.skip != 'true' && vars.STAGING_API_URL != ''
        run: |
          for i in 1 2 3 4 5; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.STAGING_API_URL }}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i: Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "Health check failed after 5 attempts"
          exit 1
        continue-on-error: true

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    # main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œì—ë§Œ í”„ë¡œë•ì…˜ ë°°í¬
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Check deploy hook
        id: check
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}
        run: |
          if [ -z "$DEPLOY_HOOK" ]; then
            echo "â­ï¸ RENDER_PRODUCTION_DEPLOY_HOOKì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
            echo ""
            echo "ðŸ”§ ì„¤ì • ë°©ë²•:"
            echo "  1. GitHub Repository â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "  2. Secrets íƒ­ì—ì„œ 'New repository secret' í´ë¦­"
            echo "  3. Name: RENDER_PRODUCTION_DEPLOY_HOOK"
            echo "  4. Value: Render Dashboard â†’ Web Service â†’ Settings â†’ Deploy Hook URL"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Render Production
        if: steps.check.outputs.skip != 'true'
        env:
          DEPLOY_HOOK: ${{ secrets.RENDER_PRODUCTION_DEPLOY_HOOK }}
        run: |
          curl -X POST "$DEPLOY_HOOK"

      - name: Wait for deployment
        if: steps.check.outputs.skip != 'true'
        run: sleep 60

      - name: Health check (with retry)
        if: steps.check.outputs.skip != 'true' && vars.PRODUCTION_API_URL != ''
        run: |
          for i in 1 2 3 4 5; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.PRODUCTION_API_URL }}/health" || echo "000")
            if [ "$response" = "200" ]; then
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i: Health check returned $response, retrying in 30s..."
            sleep 30
          done
          echo "Health check failed after 5 attempts"
          exit 1
        continue-on-error: true
