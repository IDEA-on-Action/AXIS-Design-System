# ax-wi

WI(Work Item) 라이프사이클을 관리합니다. 서브커맨드로 작업 착수, 종료, 세션 요약을 수행합니다.

## 사용법

```
/ax-wi                    # 스마트 모드 — WI 자동 감지 + 서브커맨드 자동 결정
/ax-wi start [WI-ID]     # WI 작업 착수 (SSDD 산출물 점검)
/ax-wi end [WI-ID]       # WI 작업 종료 (현행화, 동기화)
/ax-wi status [WI-ID]    # WI 상태 조회 (경량)
/ax-wi wrap-up            # 세션 전체 요약
```

---

## 서브커맨드 분기

첫 번째 인자로 서브커맨드를 결정합니다:

| 인자 | 서브커맨드 |
|------|-----------|
| `start` | WI 작업 착수 |
| `end` | WI 작업 종료 |
| `wrap-up` | 세션 요약 |
| `status` | WI 상태 조회 (경량) |
| (없음) | **스마트 모드** — 컨텍스트 자동 분석 후 적절한 서브커맨드 실행 |

---

## 스마트 모드 (인자 없음)

`/ax-wi` 를 인자 없이 호출하면 스마트 모드로 동작합니다.
컨텍스트를 자동 분석하여 WI-ID와 서브커맨드를 자동 결정합니다.

### 1. WI-ID 자동 감지

아래 우선순위 순서로 진행 중인 WI를 감지합니다:

| 우선순위 | 소스 | 방법 |
|----------|------|------|
| 1 | 대화 컨텍스트 | 현재 대화에서 `WI-NNNN` 패턴 추출 |
| 2 | project-todo.md | 🔄 상태인 WI 목록 조회 |
| 3 | git diff 경로 | `docs/workitems/WI-NNNN-*` 경로 매칭 |
| 4 | 최근 커밋 | `Refs: WI-NNNN` 패턴 추출 (`git log -5`) |

### 2. WI 자동 선택 규칙

| 조건 | 동작 |
|------|------|
| 🔄 WI가 **1개** | 확인 없이 자동 선택 (선택된 WI만 표시) |
| 🔄 WI가 **2개 이상** | 번호 목록 제시 후 사용자 선택 |
| 🔄 WI가 **0개** | 새 WI 착수 여부를 사용자에게 확인 |

### 3. 서브커맨드 자동 결정

WI가 결정된 후, 아래 조건을 **위→아래 순서**로 평가하여 첫 번째 매칭 서브커맨드를 실행합니다:

| 조건 | 서브커맨드 |
|------|-----------|
| WI 폴더 없음 또는 `todo.md` 없음 | → `start` |
| `todo.md` 존재하나 체크 항목(`[x]`)이 0개 | → `start` |
| git 변경사항 있음 + WI 관련 파일 포함 | → `end` |
| `todo.md` 전체 완료 (모든 항목 `[x]`) | → `end` |
| 위 조건 모두 미해당 | → `status` |

### 4. 실행 흐름 요약

```
/ax-wi (인자 없음)
  ├─ WI-ID 감지 (4단계 우선순위)
  ├─ WI 선택 (1개면 자동, 2개+ 면 목록)
  ├─ 서브커맨드 결정 (조건 테이블)
  └─ 해당 서브커맨드 섹션으로 이동하여 실행
```

---

## status — WI 상태 조회 (경량)

WI의 현재 진행 상태를 빠르게 확인합니다. 현행화 작업 없이 조회만 수행합니다.

### 출력 형식

```
## WI 상태: WI-NNNN-slug

### 진행률
- 전체: N개 / 완료: M개 / 남은: K개
- 진행률: XX%

### 미커밋 변경사항
| 파일 | 상태 |
|------|------|
| path/to/file.ts | modified |

### 빠른 액션
- `/ax-wi start WI-NNNN` — 작업 착수 (SSDD 점검)
- `/ax-wi end WI-NNNN` — 작업 종료 (현행화)
```

---

## start — WI 작업 착수

WI 작업 착수 전 SSDD 산출물 준비 상태를 점검하고, 부족한 것을 생성/안내합니다.

### 1. WI 식별

- 두 번째 인자로 WI ID가 전달되면 사용
- 없으면 자동 감지 (스마트 모드의 WI-ID 감지 + 선택 규칙 적용):
  - 🔄 WI가 1개 → 확인 없이 자동 선택 (선택 결과만 표시)
  - 🔄 WI가 2개+ → 목록 제시 후 선택
  - 🔄 WI가 0개 → 사용자에게 WI ID 직접 확인

### 2. WI 폴더 존재 여부 확인

```bash
ls docs/workitems/WI-NNNN-*/
```

- 폴더가 없으면 → **scaffolding 제안** (사용자 확인 후 생성)
- 생성 시 구조:

```
docs/workitems/WI-NNNN-slug/
├── prd.md
├── todo.md
├── plan.md
├── testplan.md
└── release-notes.md
```

### 3. 필수 산출물 점검 (Gate 검증)

#### Gate 1: PRD 검증

1. `prd.md` 파일 존재 여부
2. AC(수용 기준) 섹션 정의 여부 확인
3. 미비 시 → 템플릿(`docs/templates/component-prd.md`) 기반 초안 생성 제안

#### Gate 2: TODO 검증

1. `todo.md` 파일 존재 여부
2. PRD 기반으로 생성되었는지 확인 (AC 항목 매핑)
3. 미비 시 → PRD의 AC 기반 TODO 생성 제안

### 4. project-todo.md 상태 확인

1. 해당 WI ID의 상태가 🔄(진행 중)인지 확인
2. 상태가 다르면 🔄로 갱신 제안

### 5. 작업 컨텍스트 요약 출력

```
## WI 작업 시작: WI-NNNN-slug

### WI 정보
- **WI ID**: WI-NNNN
- **제목**: [WI 제목]
- **상태**: 🔄 진행 중

### SSDD 산출물 상태
| 산출물 | 상태 | 비고 |
|--------|------|------|
| prd.md | ✅ 존재 / ❌ 미비 | AC N개 정의 |
| todo.md | ✅ 존재 / ❌ 미비 | N/M 완료 |
| plan.md | ✅ / ⬜ 선택 | - |
| testplan.md | ✅ / ⬜ 선택 | - |
| release-notes.md | ⬜ 미작성 | 릴리스 시 작성 |

### Gate 검증 결과
- Gate 1 (PRD + AC): ✅ 통과 / ❌ 미충족 — [사유]
- Gate 2 (TODO + PRD 연결): ✅ 통과 / ❌ 미충족 — [사유]

### PRD 핵심 요약
- **목표**: [PRD 목표 요약]
- **범위**: [범위 요약]
- **수용 기준 (AC)**:
  1. [AC-1]
  2. [AC-2]

### TODO 진행 상황
- 전체: N개 / 완료: M개 / 남은: K개
- 다음 수행할 Task:
  - [ ] [다음 Task 설명]

---
작업 시작: [현재 시간 KST]
```

### 산출물 미비 시 자동 조치

| 상황 | 조치 |
|------|------|
| WI 폴더 없음 | 생성 여부 확인 후 scaffolding |
| prd.md 없음 | 템플릿 기반 초안 생성 제안 |
| prd.md AC 미정의 | AC 섹션 추가 안내 |
| todo.md 없음 | PRD AC 기반 TODO 생성 제안 |
| project-todo.md 미등록 | 항목 추가 제안 |

### 주의사항

- Gate 미충족 시 작업 진행 여부를 사용자에게 확인
- 산출물 자동 생성 전 반드시 사용자 승인
- PRD 없이 TODO 생성 금지 (SSDD 원칙)

---

## end — WI 작업 종료

WI 작업 구간 종료 시 SSDD 산출물과 project-todo.md를 현행화합니다.

### 옵션

| 인자 | 설명 |
|------|------|
| `<WI-ID>` | WI ID 직접 지정 (예: `/ax-wi end WI-0003`) |
| `commit` | 현행화 후 커밋까지 진행 |

WI ID가 없으면 아래 우선순위로 자동 감지합니다:

1. 대화 컨텍스트에서 `WI-NNNN` 패턴 추출
2. project-todo.md에서 🔄 상태 WI 조회 (1개면 자동 선택)
3. git diff 경로에서 `docs/workitems/WI-NNNN-*` 매칭
4. 최근 커밋 메시지에서 `Refs: WI-NNNN` 추출
5. 감지 실패 시 사용자에게 직접 확인

### 1. WI 식별 + 변경사항 수집

```bash
git status
git diff --stat
```

### 2. todo.md 현행화

1. `docs/workitems/WI-NNNN-slug/todo.md` 읽기
2. 이번 작업에서 완료된 항목 식별 (변경 파일, 대화 컨텍스트 기반)
3. 완료 항목: `[ ]` → `[x]` 갱신
4. Definition of Done 체크:

```markdown
- [x] 타입 체크 통과
- [x] 린트 통과
- [x] 빌드 성공
- [x] 관련 문서 업데이트
```

### 3. project-todo.md 동기화

1. 해당 WI의 todo.md 진행률 계산 (완료/전체)
2. Phase 진행률 재계산
3. 전체 완료 시:
   - 상태 🔄 → ✅ 변경
   - 완료일 기록 (YYYY-MM-DD)
4. 미완료 시:
   - 상태 🔄 유지
   - 진행률만 갱신

### 4. 커밋 메시지 제안

WI 참조를 포함한 커밋 메시지를 제안합니다:

```
<type>(<scope>): <subject>

- [변경 요약 1]
- [변경 요약 2]

Refs: WI-NNNN
```

`commit` 옵션 시 사용자 확인 후 커밋 실행.

### 5. 다음 단계 안내

1. 남은 TODO 항목 목록
2. 다음 SSDD Gate 필요 여부:
   - 구현 완료 → testplan.md 작성 안내
   - 테스트 완료 → release-notes.md 작성 안내
3. 관련 스킬 안내 (`/ax-build`, `/ax-release` 등)

### 출력 형식

```
## WI 작업 종료: WI-NNNN-slug

### 변경사항 요약
| 파일 | 변경 유형 | 설명 |
|------|-----------|------|
| path/to/file.ts | 수정 | [변경 내용] |

### todo.md 현행화
- 갱신 항목: N개 ([ ] → [x])
- 전체 진행률: M/T (XX%)

### project-todo.md 동기화
- WI 상태: 🔄 진행 중 / ✅ 완료
- Phase 진행률: XX% → YY%

### 커밋 메시지 제안
<type>(<scope>): <subject>

Refs: WI-NNNN

### 다음 단계
- 남은 Task: K개
- 다음 Gate: [testplan / release-notes / 없음]
- 권장 스킬: [/ax-build, /ax-release 등]

---
작업 종료: [현재 시간 KST]
```

### 주의사항

- todo.md 갱신 전 현재 상태를 반드시 확인 (이미 체크된 항목 중복 방지)
- project-todo.md 상태 변경은 todo.md 전체 완료 시에만 ✅ 처리
- 커밋 실행은 반드시 사용자 확인 후 진행

---

## wrap-up — 세션 요약

현재 세션에서 수행한 작업을 정리하고 요약합니다.
**현행화 로직은 포함하지 않습니다.** WI 작업인 경우 먼저 `/ax-wi end`를 실행하세요.

### 옵션

| 인자 | 설명 |
|------|------|
| (없음) | 기본 요약 |
| `commit` | 미커밋 변경사항을 커밋 제안 |
| `detailed` | 상세 diff 포함 |

### 1. 변경사항 수집

```bash
git status
git diff --stat
```

### 2. 최근 커밋 확인 (이번 세션)

```bash
git log --oneline -10
```

### 3. 출력 형식

```
## 세션 요약

### 수행한 작업
1. [작업 1 설명]
2. [작업 2 설명]

### 변경된 파일
| 파일 | 변경 유형 | 설명 |
|------|-----------|------|
| path/to/file.ts | 수정 | [변경 내용] |

### 커밋 내역
- [commit hash] [커밋 메시지]

### 미완료 작업
- [ ] [남은 작업 1]
- [ ] [남은 작업 2]

### 다음 단계 권장사항
1. [권장 작업 1]
2. [권장 작업 2]

---
세션 종료: [현재 시간 KST]
```

### commit 모드

미커밋 변경사항이 있으면 커밋 메시지 제안 후 사용자 확인.

### detailed 모드

각 파일의 상세 변경 내용(추가/삭제 라인, 주요 변경) 포함.

### WI 작업 감지

WI 관련 변경이 감지되면 `/ax-wi end`를 먼저 실행하도록 안내합니다.

### 프롬프트 자동 감지 (선택)

세션 종료 시 `/ax-prompt detect`를 실행하여 재사용 후보를 탐지합니다.
