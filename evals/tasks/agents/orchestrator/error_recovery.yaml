# Orchestrator Agent - 에러 복구 시나리오
# 서브에이전트 실패 시 적절한 복구 동작을 수행하는지 테스트

task:
  id: orchestrator_error_recovery
  type: workflow
  desc: "에러 복구 시나리오 - 서브에이전트 타임아웃/실패 시 재시도 및 fallback 처리 검증"
  suite: orchestrator_capability
  version: "1.0.0"

  metadata:
    domain: functionality
    difficulty: hard
    risk: high
    purpose: capability
    expected_pass_rate: 0.85
    owner: "ax-bd-team"
    created_at: "2026-01-18"

  inputs:
    prompt: |
      Seminar Pipeline(WF-01) 워크플로를 실행하세요.

      주의: 첫 번째 confluence_sync 호출이 타임아웃될 것입니다.
      에러 처리 규칙에 따라 최대 3회 재시도 후 로컬 저장 fallback을 수행하세요.

      입력 데이터:
      - type: seminar
      - url: https://event.example.com/tech-conf-2026
      - play_id: EXT_Desk_D01_Seminar
    context:
      workflow_id: "WF-01"
      simulate_error:
        agent: "confluence_sync"
        error_type: "timeout"
        fail_count: 2
      expected_behavior:
        - "3회 재시도"
        - "로컬 저장 fallback"
        - "재시도 큐 등록"

  success_criteria:
    description: "에러 발생 시 적절한 복구 동작 수행"
    outcome_checks:
      - type: state_equals
        target: "retry_count"
        value: 3
        description: "최대 3회 재시도"
      - type: state_equals
        target: "fallback_executed"
        value: true
        description: "fallback 실행됨"

  graders:
    - type: tool_call_check
      id: retry_behavior
      weight: 0.4
      required: true
      description: "재시도 동작 검증"
      config:
        required_calls:
          - tool: "call_agent"
            min_count: 3
            max_count: 4
            args_match:
              agent_name: "confluence_sync"
          - tool: "queue_for_retry"
            min_count: 1

    - type: state_check
      id: fallback_state
      weight: 0.3
      description: "fallback 상태 검증"
      config:
        checks:
          - type: state_equals
            target: "local_save.executed"
            expected: true
            description: "로컬 저장 실행됨"
          - type: state_equals
            target: "retry_queue.contains"
            expected: "confluence_sync"
            operator: contains
            description: "재시도 큐에 등록됨"

    - type: llm_assertion
      id: error_handling_logic
      weight: 0.3
      description: "에러 처리 로직 검증"
      config:
        model: "claude-sonnet-4-20250514"
        assertions:
          - statement: "Confluence 연결 실패 시 즉시 포기하지 않고 재시도를 수행했다"
            weight: 1.0
            required: true
          - statement: "최대 재시도 횟수 초과 후 로컬 저장 fallback을 수행했다"
            weight: 1.0
            required: true
          - statement: "워크플로 전체가 실패하지 않고 계속 진행되었다"
            weight: 0.8

  scoring:
    mode: weighted
    pass_threshold: 0.75
    required_graders:
      - retry_behavior

  timeout:
    total_seconds: 360
    per_turn_seconds: 60
    grading_seconds: 90

  cost_budget:
    max_tokens: 60000
    max_usd: 1.5

  tags:
    - orchestrator
    - error-recovery
    - capability
    - resilience
